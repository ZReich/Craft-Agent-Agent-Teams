
> craft-agent@0.4.1 test
> vitest run -c vitest.config.ts


[1m[46m RUN [49m[22m [36mv4.0.18 [39m[90mC:/Users/monta/prototypes/craft-agents-teams[39m

 [32mâœ“[39m packages/shared/src/usage/__tests__/usage-alerts.test.ts [2m([22m[2m34 tests[22m[2m)[22m[32m 14[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/core/__tests__/session-lifecycle.test.ts [2m([22m[2m21 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/core/__tests__/usage-tracker.test.ts [2m([22m[2m22 tests[22m[2m)[22m[32m 11[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/core/__tests__/planning-advisor.test.ts [2m([22m[2m20 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/__tests__/codex-skills.test.ts [2m([22m[2m21 tests[22m[2m)[22m[32m 15[2mms[22m[39m
 [32mâœ“[39m apps/electron/src/renderer/hooks/__tests__/useMultiSelect.test.ts [2m([22m[2m38 tests[22m[2m)[22m[32m 17[2mms[22m[39m
 [32mâœ“[39m apps/electron/src/renderer/utils/__tests__/auth-validation.test.ts [2m([22m[2m51 tests[22m[2m)[22m[32m 15[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/usage/__tests__/usage-persistence.test.ts [2m([22m[2m29 tests[22m[2m)[22m[32m 134[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/__tests__/codex-reconnect.integration.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 268[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/__tests__/codex-source-toggle.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 270[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/__tests__/tool-matching-sdk-fixtures.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 17[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/__tests__/tool-matching.test.ts [2m([22m[2m51 tests[22m[2m)[22m[32m 55[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/usage/__tests__/pricing.test.ts [2m([22m[2m29 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m apps/electron/src/__tests__/smoke.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 5[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/sources/__tests__/basic-auth.test.ts [2m([22m[2m13 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/__tests__/agent-team-presets.test.ts [2m([22m[2m2 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m packages/core/src/__tests__/smoke.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 4[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/__tests__/smoke.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 4[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/__tests__/agent-team-model-resolution.test.ts [2m([22m[2m2 tests[22m[2m)[22m[32m 3[2mms[22m[39m
[90mstdout[2m | packages/shared/src/auth/__tests__/oauth.e2e.test.ts[2m > [22m[2mE2E: OAuth Metadata Discovery[2m > [22m[2mGitHub MCP (api.githubcopilot.com)[2m > [22m[2mdiscovers OAuth metadata
[22m[39mGitHub MCP: No metadata discovered (server may require auth or be unavailable)
Discovery logs: [
  [32m'Discovering OAuth metadata for https://api.githubcopilot.com/mcp/'[39m,
  [32m'  Trying: https://api.githubcopilot.com/.well-known/oauth-authorization-server'[39m,
  [32m'  âœ— 404 at https://api.githubcopilot.com/.well-known/oauth-authorization-server'[39m,
  [32m'  Trying: https://api.githubcopilot.com/.well-known/oauth-authorization-server/mcp/'[39m,
  [32m'  âœ— 404 at https://api.githubcopilot.com/.well-known/oauth-authorization-server/mcp/'[39m,
  [32m'No OAuth metadata found for https://api.githubcopilot.com/mcp/'[39m
]

 [32mâœ“[39m packages/shared/src/agent/core/__tests__/permission-manager.test.ts [2m([22m[2m21 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/core/__tests__/source-manager.test.ts [2m([22m[2m21 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/__tests__/source-state.test.ts [2m([22m[2m29 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/sources/__tests__/authScheme-empty.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 4[2mms[22m[39m
[90mstdout[2m | packages/shared/src/auth/__tests__/oauth.e2e.test.ts[2m > [22m[2mE2E: OAuth Metadata Discovery[2m > [22m[2mLinear MCP (mcp.linear.app)[2m > [22m[2mdiscovers OAuth metadata
[22m[39mLinear MCP OAuth metadata: {
  issuer: [32m'https://mcp.linear.app'[39m,
  authorization_endpoint: [32m'https://mcp.linear.app/authorize'[39m,
  token_endpoint: [32m'https://mcp.linear.app/token'[39m,
  registration_endpoint: [32m'https://mcp.linear.app/register'[39m,
  response_types_supported: [ [32m'code'[39m ],
  response_modes_supported: [ [32m'query'[39m ],
  grant_types_supported: [ [32m'authorization_code'[39m, [32m'refresh_token'[39m ],
  token_endpoint_auth_methods_supported: [ [32m'client_secret_basic'[39m, [32m'client_secret_post'[39m, [32m'none'[39m ],
  revocation_endpoint: [32m'https://mcp.linear.app/token'[39m,
  code_challenge_methods_supported: [ [32m'plain'[39m, [32m'S256'[39m ],
  client_id_metadata_document_supported: [33mfalse[39m
}

 [32mâœ“[39m packages/shared/src/sources/__tests__/server-builder-authScheme.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/__tests__/base-agent.test.ts [2m([22m[2m35 tests[22m[2m)[22m[32m 15[2mms[22m[39m
[90mstdout[2m | packages/shared/src/auth/__tests__/oauth.e2e.test.ts[2m > [22m[2mE2E: OAuth Metadata Discovery[2m > [22m[2mAhrefs MCP (api.ahrefs.com/mcp/mcp)[2m > [22m[2mdiscovers OAuth metadata
[22m[39mAhrefs MCP OAuth metadata: {
  issuer: [32m'https://api.ahrefs.com/'[39m,
  registration_endpoint: [32m'https://api.ahrefs.com/mcp/register'[39m,
  authorization_endpoint: [32m'https://app.ahrefs.com/web/oauth/authorize'[39m,
  token_endpoint: [32m'https://ahrefs.com/oauth/token'[39m,
  response_types_supported: [ [32m'code'[39m ],
  scopes_supported: [ [32m'apiv3-mcp'[39m ],
  code_challenge_methods_supported: [ [32m'S256'[39m ]
}

 [32mâœ“[39m packages/shared/src/auth/__tests__/oauth.e2e.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 975[2mms[22m[39m
       [33m[2mâœ“[22m[39m discovers OAuth metadata [33m 572[2mms[22m[39m
 [31mâ¯[39m packages/shared/src/agent/__tests__/codex-agent-completion.test.ts [2m([22m[2m5 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[32m 21[2mms[22m[39m
[31m     [31mÃ—[31m does not emit complete event when team is active (REQ-001)[39m[32m 9[2mms[22m[39m
     [32mâœ“[39m emits usage_update instead of complete when team is active (REQ-002)[32m 4[2mms[22m[39m
     [32mâœ“[39m emits complete event normally when no team is active (REQ-003)[32m 2[2mms[22m[39m
     [32mâœ“[39m emits complete when team exists but has zero teammates[32m 2[2mms[22m[39m
     [32mâœ“[39m transitions from usage_update to complete when team becomes inactive[32m 3[2mms[22m[39m
 [32mâœ“[39m packages/shared/src/agent/__tests__/codex-agent-teams.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 38[2mms[22m[39m

[31mâ¯â¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Tests 1 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m packages/shared/src/agent/__tests__/codex-agent-completion.test.ts[2m > [22mAgent completion behavior with teams[2m > [22mdoes not emit complete event when team is active (REQ-001)
[31m[1mTypeError[22m: agent.ensureConnected is not a function[39m
[36m [2mâ¯[22m packages/shared/src/agent/__tests__/codex-agent-completion.test.ts:[2m110:28[22m[39m
    [90m108| [39m    [35mif[39m ([33m![39mturnCompletedHandler) {
    [90m109| [39m      [90m// Trigger initialization to register handlers[39m
    [90m110| [39m      [35mawait[39m (agent [35mas[39m any)[33m.[39m[34mensureConnected[39m()[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m111| [39m    }
    [90m112| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m27 passed[39m[22m[90m (28)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m502 passed[39m[22m[90m (503)[39m
[2m   Start at [22m 19:45:42
[2m   Duration [22m 2.00s[2m (transform 7.91s, setup 0ms, import 13.03s, tests 1.96s, environment 5ms)[22m

